<%= render "shared/white_header" %>
<div class="mypage">
  <div class="mypage-upper">

    <% if current_user == @user %>
      <%= content_tag :div,
        id: "user-profile-app",
        data: {
          id: @user.id,
          name: @user.name,
          username: @user.username,
          bio: @user.bio,
          image: @user.image_url,
          followings: @user.followings_count,
          followers: @user.followers_count,
        }.to_json do %>
      <% end %>
    <% else %>
      <%= render "users/profile", user: @user %>
    <% end %>

    <div class="mypage-menu">
      <ul>
        <li>
          <%= link_to "Bookshelf", "/@#{@user.username}/bookshelf",
            class: @menu.eql?("bookshelf") || @menu.blank? ? "active menu-item" : "menu-item" %>
        </li>
        <li>
          <%= link_to "Likes", "/@#{@user.username}/likes",
            class: @menu.eql?("likes") ? "active menu-item" : "menu-item" %>
        </li>
        <% if current_user == @user %>
          <li>
            <%= link_to "Drafts", "/@#{@user.username}/drafts",
            class: @menu.eql?("drafts") ? "active menu-item" : "menu-item" %>
          </li>
        <% end %>
      </ul>
    </div>
  </div>
  <div class="mypage-lower">
    <% if @menu == "bookshelf" || @menu.blank? %>
      <%= content_tag :div,
        id: "bookshelf-app",
        data: {
          userId: @user.id
        }.to_json do %>
      <% end %>
    <% end %>
    <% if @menu == "likes" %>
      <%= content_tag :div,
        id: "bookmark-tab-app",
        data: {
          userId: @user.id,
        }.to_json do %>
      <% end %>
    <% end %>
    <% if @menu == "drafts" && @user == current_user %>
      <div class="draft-list">
        <% @draft_posts.each do |post| %>
          <div class="draft-list-item">
            <h2 class="post-title"><%= post.title_draft.present? ? post.title_draft : "タイトル未設定" %></h2>
            <div class="item-footer clearfix">
              <p class="last-edited">Last edited <%= format_date(post.updated_at) %></p>
              <div class="menu-wrapper">
                <i class="fa fa-chevron-down draft-menu-down" aria-hidden="true"></i>
                <div class="draft-menu"></div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script type="text/javascript">
function displayMenu(e) {
  e.preventDefault();
  e.stopPropagation();
  var menu = e.target.nextElementSibling;
  menu.setAttribute("style", "display: block;");
}

function hideMenu(e) {
  e.preventDefault();
  var nodes = document.getElementsByClassName("draft-menu");
  for (var i = 0; i < nodes.length; i++) {
    var node = nodes[i];
    node.setAttribute("style", "display: none;");
  }
}

document.addEventListener("DOMContentLoaded", function() {
  var nodes = document.getElementsByClassName("draft-menu-down");

  for (var i = 0; i < nodes.length; i++) {
    var node = nodes[i];
    node.addEventListener("click", displayMenu, false);
  }

  document.body.addEventListener("click", hideMenu, false);

  var nodes = document.getElementsByClassName("draft-menu");
  for (var i = 0; i < nodes.length; i++) {
    var node = nodes[i];
    node.addEventListener("click", function(e) {
      e.preventDefault();
      e.stopPropagation();
    }, false);
  }
}, false);

</script>
